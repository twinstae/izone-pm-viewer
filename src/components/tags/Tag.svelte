<script lang="ts">
import { all_tag_dict } from "../../stores/all_tag_dict";
import { mail_to_tag_dict } from "../../stores/mail_to_tag_dict";
import { tag_to_mail_dict } from "../../stores/tag_to_mail_dict";
import { now_pm } from "../../stores/now";
import { selected_tag_value } from "../../stores/tag";
import { goto, params } from "@roxi/routify";
import { getContext } from "svelte";
import TagModal from "./TagModal.svelte";
import NickModal from "../modals/NickModal.svelte";
import { base_tag_set, member_color_to_dark_dict } from "../../stores/constants";
import Icon from 'fa-svelte';
import { faTwitter } from '@fortawesome/free-brands-svg-icons/faTwitter';
import { faFacebook } from '@fortawesome/free-brands-svg-icons/faFacebook';
import { faInstagram } from '@fortawesome/free-brands-svg-icons/faInstagram';
import { faYoutube } from '@fortawesome/free-brands-svg-icons/faYoutube';
import {faStar} from '@fortawesome/free-solid-svg-icons/faStar';
import { dark, dynamic_dark_border } from "../../stores/preferences";
import api from "../../api";

export let tag: {
    value: string,
    color: string
};
export let canDelete = false;
export let size = "xs";
export let onRemove = null;

$: onDeleteTag = async ()=>{
    const the_tag = $all_tag_dict.get(tag.value);   

    tag_to_mail_dict.update(dict=>{
      if (dict.has(the_tag)){
          dict.get(the_tag).delete($now_pm.id);
      }
      return dict;
    })

    mail_to_tag_dict.update(dict=>{
      if (dict.has($now_pm.id)){
          dict.get($now_pm.id).delete(the_tag)
      }
      return dict;
    });

    await api.MailTagDict.deleteTag($now_pm.id, tag.value)
      .then((_)=>{console.log("ÏÑúÎ≤ÑÏóêÏÑú ÌÉúÍ∑∏ ÏÇ≠Ï†ú ÏÑ±Í≥µ")});
}

const onSelectTag = (tag: TagT)=>
()=>{
    $selected_tag_value = tag.value;
    $goto("./", {...$params, tag: tag.value, nowPage:1})
}

const {open} = getContext("simple-modal");

let timeout: ReturnType<typeof setTimeout>;
$: onTouchDown = ()=>{
    if(tag.color == "rainbow"){
        timeout = setTimeout(()=>{open(NickModal)}, 500);
        return null;
    }

    if(base_tag_set.has(tag.value)){
        timeout = setTimeout(()=>{console.log("Í∏∞Î≥∏ ÌÉúÍ∑∏Îäî ÏïÑÏßÅ ÏàòÏ†ïÌï† Ïàò ÏóÜÏäµÎãàÎã§.")}, 300)
    } else {
        timeout = setTimeout(()=>{open(TagModal, { tag: tag})}, 300);
    }
};
$: onTouchUp = (_: Event) =>{ clearTimeout(timeout); }

const iconDict = new Map([
    ["Ìä∏ÏúÑÌÑ∞", faTwitter],
    ["ÌéòÏù¥Ïä§Î∂Å", faFacebook],
    ["Ïù∏Ïä§ÌÉÄ", faInstagram],
    ["Ïú†ÌäúÎ∏å", faYoutube],
]);

$: padding = tag.color=="#fff" || tag.color == "rainbow" ? "border-2 p-0.5" : "p-1";
$: border = onRemove || (canDelete && tag.value!="ÏÉùÏùº")
    ? "rounded-l border-r-0"
    : "rounded";

$: backgroud_color = tag.value=="ÌÉÄÏûÑÏ∫°Ïäê" ? "#555" : tag.color;
$: dark_bg_color = member_color_to_dark_dict[backgroud_color];

$: text_color = ()=>{
    if (tag.value=="ÌÉÄÏûÑÏ∫°Ïäê"){
        return "#b299e6";
    }
    if (tag.value=="üíñ"){
        return "#ffb40d";
    }
    return "black";
}

$: get_dark_text_color = ()=>{
    if(text_color() != "black"){
        return text_color();
    }
    if (tag.value == "ÍπÄÎØºÏ£º" || tag.value == "ÏµúÏòàÎÇò"){
        return "#333";
    }
    return "#eee"
};

$: icon = iconDict.get(tag.value);

$: style = tag.color=="rainbow"
  ? `background-image: linear-gradient(
    to right,
    #f1d2e7,#f1c3aa,#e382a9, #e18784,
    #f3aa51, #fcf695, #fff,#cee5d5,
    #a7e0e1, #b7d3e9, #bbb0dc, #7592d7);
    color: black;`
  : `background-color: ${$dark ? dark_bg_color : backgroud_color};
            color: ${$dark ? get_dark_text_color(): text_color()};`
</script>
<style>
    span {
        word-break: keep-all;
        white-space: nowrap;
    }
</style>

<span
style={style}
   class="
{$dynamic_dark_border} {padding} {border}
{tag.color=='#fff' ? 'border-2 p-0.5' : 'p-1'}
rounded m-0.5 text-{size}">

<span
on:pointerdown={onTouchDown}
on:pointerup={onTouchUp}
on:click={onSelectTag(tag)}
class="Tag-{tag.value.replace(" ", "-")}  text-{size}
{tag.value=="üíñ" ? "pt-0" : ""}">
    {#if tag.value=="üíñ"}
        <Icon icon={faStar} />
    {:else}
        {#if iconDict.has(tag.value)}
        <Icon
        class="mb-1 text-white"
        icon={icon} />
        {/if}
    {tag.value}
    {/if}
</span>

{#if onRemove || (canDelete && tag.value!="ÏÉùÏùº")}
<span
on:click={onRemove ? onRemove : onDeleteTag}
class="{onRemove ? 'Remove' : 'Delete'}Tag-{tag.value.replace(' ', '-')}">

X</span>
{/if}

</span>
